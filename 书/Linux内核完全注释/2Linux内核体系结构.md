### 5.3.2内存地址空间概念
共有三种地址：
* 虚拟地址：由段选择子和偏移地址构成，选择子的索引13bit，还有1bit来选GDT还是LDT，因此8086可以索引16384个选择符，每个段如果最大4G，那最大虚拟地址空间为64T。
* 线性地址：由段选择子查找到了DT中的某段，找到了存在其中的段基址，加上段内偏移，就形成了线性地址
* 物理地址：如果启用了内存分页，那线性地址可以再经查页表后产生一个物理地址，如果没启用分页机制，那线性地址就是物理地址。
### 5.3.2内存分段机制
![[Pasted image 20240424094958.png]]
**虚拟内存康健的含义是指一种利用二级或外部存储空间，使程序不受物理内存限制而使用内存的方法**。当程序请求了一块不存在的内存，会引起缺页异常，并把引起中断的线性地址放入CR2，处理该中断，即可实现把这个页换入内存，如果内存满了，也可以长时间没用的内存换出，然后再把需要的页换入。
![[Pasted image 20240424100033.png]]
### 5.3.4内存分页管理
为了实现每个程序拥有的内存大于物理内存，就需要使用内存分页，80386使用了页表目录和页表项。
![[Pasted image 20240424104148.png]]
Linux0.1x中，系统内核和所有任务共用一个页目录表，所以所有任务的线性地址空间到物理地址空间的映射函数一模一样，所以必须在虚拟地址空间映射到线性地址空间时进行分割，也就是每个虚拟地址需要占用不同的线性地址空间范围。所以这些老Linux系统，总的线性地址空间也就4GB，也就是所有任务只能共用这4GB线性地址空间。Linux0.1x每个进程的虚拟内存空间最大为64MB，所以**每个进程的逻辑地址通过加上(任务号)x64MB**即可转化为线性地址空间中的地址。
### 5.35CPU多任务和保护方式
8086CPU分为4个保护剂级，0级具有最高优先级，3级最低，linux使用了0级和3级，进程运行于内核态时，处于0级优先级。处于用户态时，处于3级优先级。
### 5.36三种地址之间的关系
head.s中已经把内核代码段和数据段都设置为长度16M的段，在线性地址空间这俩段重叠（段表中基址相同），该范围内包含所有内核代码，段表，页目录和二级页表、内核局部数据和内核临时堆栈（被用作任务0的用户堆栈）。页目录表和页表已经把前16M内存对应到了物理内存上，占用4个页目录。
![[Pasted image 20240425112850.png]]
